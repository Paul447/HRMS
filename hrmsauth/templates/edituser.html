{% comment %} {% extends "dashboard.html" %}
{% block title %}
    Edit User
{% endblock %}
{% block content %}

<div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h3 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Edit User</h3>
    <form id="edit-form" method="POST" action="/api/users/{{ user.id }}/" class="space-y-5">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="username" class="block mb-1 font-medium text-gray-700">Username*</label>
                <input type="text" name="username" id="username" value="{{ user.username }}" required
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500"/>
            </div>
            <div>
                <label for="email" class="block mb-1 font-medium text-gray-700">Email*</label>
                <input type="email" name="email" id="email" value="{{ user.email }}" required
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500"/>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="password" class="block mb-1 font-medium text-gray-700">Password*</label>
                <input type="password" name="password" id="password"
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500"
                    placeholder="Leave blank to keep current password"/>
            </div>
            <div>
                <label for="confirm_password" class="block mb-1 font-medium text-gray-700">Confirm Password*</label>
                <input type="password" name="confirm_password" id="confirm_password"
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500"
                    placeholder="Leave blank to keep current password"/>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="date_joined" class="block mb-1 font-medium text-gray-700">Join Date & Time</label>
                <input type="datetime-local" name="date_joined" id="date_joined"
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500"
                    value="{{ user.date_joined|date:'Y-m-d\\TH:i' }}"/>
            </div>
            <div class="flex items-center space-x-4 pt-6">
                <label class="inline-flex items-center">
                    <input type="checkbox" name="is_staff" id="is_staff"
                        {% if user.is_staff %}checked{% endif %}
                        class="rounded h-5 w-5 border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                    <span class="ml-2 text-gray-700">Is Staff</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" name="is_superuser" id="is_superuser"
                        {% if user.is_superuser %}checked{% endif %}
                        class="rounded h-5 w-5 border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                    <span class="ml-2 text-gray-700">Is Superuser</span>
                </label>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="groups" class="block mb-1 font-medium text-gray-700">Groups</label>
                <select name="groups" id="groups" multiple
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500">
                    {% for group in groups %}
                        <option value="{{ group.id }}" {% if group.id in user_group_ids %}selected{% endif %}>{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="user_permissions" class="block mb-1 font-medium text-gray-700">User Permissions</label>
                <select name="user_permissions" id="user_permissions" multiple
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-indigo-500">
                    {% for perm in permissions %}
                        <option value="{{ perm.id }}" {% if perm.id in user_permission_ids %}selected{% endif %}>{{ perm.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="pt-4">
            <button type="submit"
                class="w-full py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors">
                Update User
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('edit-form');

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const groups = Array.from(document.getElementById('groups').selectedOptions).map(opt => opt.value);
        const permissions = Array.from(document.getElementById('user_permissions').selectedOptions).map(opt => opt.value);

        const payload = {
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            confirm_password: formData.get('confirm_password'),
            date_joined: formData.get('date_joined'),
            is_staff: formData.get('is_staff') === 'on',
            is_superuser: formData.get('is_superuser') === 'on',
            groups: groups,
            user_permissions: permissions,
        };

        fetch(form.action, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                'Accept': 'application/json',
            },
            body: JSON.stringify(payload),
        })
        .then(response => {
            if (response.ok) {
                alert('User updated successfully.');
                // Optionally redirect or reload
            } else if (response.status === 400) {
                return response.json().then(data => {
                    Object.keys(data).forEach(field => {
                        const el = form.querySelector(`[name=${field}]`);
                        if (el) {
                            const error = document.createElement('div');
                            error.textContent = data[field];
                            error.classList.add('text-red-500', 'text-sm');
                            el.parentNode.appendChild(error);
                        }
                    });
                });
            } else {
                throw new Error('Unexpected error');
            }
        })
        .catch(err => {
            alert('Failed to update user.');
            console.error(err);
        });
    });
});
document.addEventListener('DOMContentLoaded', function () {
    const userId = "{{ user.id }}";  // Provided by Django context

    fetch(`/api/users/${userId}/`)
        .then(res => res.json())
        .then(data => {
            // Populate form fields
            document.getElementById('username').value = data.username || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('date_joined').value = data.date_joined?.slice(0, 16) || '';
            document.getElementById('is_staff').checked = data.is_staff || false;
            document.getElementById('is_superuser').checked = data.is_superuser || false;

            // Pre-select groups
            const groupSelect = document.getElementById('groups');
            for (let option of groupSelect.options) {
                if (data.groups.includes(parseInt(option.value))) {
                    option.selected = true;
                }
            }

            // Pre-select permissions
            const permSelect = document.getElementById('user_permissions');
            for (let option of permSelect.options) {
                if (data.user_permissions.includes(parseInt(option.value))) {
                    option.selected = true;
                }
            }
        })
        .catch(err => console.error("Failed to fetch user details:", err));
});

</script>

{% endblock %} {% endcomment %}
