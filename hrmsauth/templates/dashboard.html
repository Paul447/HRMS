<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow-md">
    <h1 class="text-2xl font-bold mb-4">Protected Dashboard</h1>
    <p class="text-gray-700 mb-4">Welcome! Here is your protected data:</p>
    <div id="protectedData" class="bg-gray-50 p-4 border rounded text-sm font-mono text-gray-800"></div>
  </div>

  <script>
    function isAccessTokenExpired(token) {
      if (!token) return true;
      const decoded = JSON.parse(atob(token.split('.')[1]));
      const exp = decoded.exp * 1000;
      return exp < Date.now();
    }

    function refreshAccessToken() {
      const refresh = localStorage.getItem('refreshToken');
      if (!refresh) return;

      return fetch('http://localhost:8000/api/token/refresh/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refresh }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.access) {
          localStorage.setItem('accessToken', data.access);
          return data.access;
        } else {
          window.location.href = 'index.html';
        }
      });
    }

    async function loadProtectedData() {
      let accessToken = localStorage.getItem('accessToken');
      
      if (isAccessTokenExpired(accessToken)) {
        accessToken = await refreshAccessToken();
      }

      if (!accessToken) {
        alert('Session expired. Please login again.');
        window.location.href = 'index.html';
        return;
      }

      fetch('http://localhost:8000/api/protected/', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('protectedData').textContent = JSON.stringify(data, null, 2);
      })
      .catch(err => {
        console.error('Protected fetch error:', err);
        alert('Failed to fetch protected data.');
      });
    }

    window.onload = loadProtectedData;
  </script>
</body>
</html>
