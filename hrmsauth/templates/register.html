{% comment %} {% extends "dashboard.html" %}
{% block title %}
    Register New User
{% endblock %}
{% block content %}

<div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h3 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Register New User</h3>
    <form id="register-form" method="POST" action="/api/users/" class="space-y-5">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="username" class="block mb-1 font-medium text-gray-700">Username*</label>
                <input type="text" name="username" id="username" required
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" 
                    placeholder="Enter username"/>
            </div>

            <div>
                <label for="email" class="block mb-1 font-medium text-gray-700">Email*</label>
                <input type="email" name="email" id="email" required
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                    placeholder="user@example.com"/>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="password" class="block mb-1 font-medium text-gray-700">Password*</label>
                <input type="password" name="password" id="password" required
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                    placeholder="••••••••"/>
            </div>

            <div>
                <label for="confirm_password" class="block mb-1 font-medium text-gray-700">Confirm Password*</label>
                <input type="password" name="confirm_password" id="confirm_password" required
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"
                    placeholder="••••••••"/>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="date_joined" class="block mb-1 font-medium text-gray-700">Join Date & Time</label>
                <input type="datetime-local" name="date_joined" id="date_joined"
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"/>
            </div>
            
            <div class="flex items-center space-x-4 pt-6">
                <label class="inline-flex items-center">
                    <input type="checkbox" name="is_staff" id="is_staff"
                        class="rounded h-5 w-5 border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                    <span class="ml-2 text-gray-700">Is Staff</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" name="is_superuser" id="is_superuser"
                        class="rounded h-5 w-5 border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                    <span class="ml-2 text-gray-700">Is Superuser</span>
                </label>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label for="groups" class="block mb-1 font-medium text-gray-700">Groups</label>
                <select name="groups" id="groups" multiple
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Hold Ctrl (Cmd on Mac) to select multiple</p>
            </div>

            <div>
                <label for="user_permissions" class="block mb-1 font-medium text-gray-700">User Permissions</label>
                <select name="user_permissions" id="user_permissions" multiple
                    class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    {% for perm in permissions %}
                    <option value="{{ perm.id }}">{{ perm.name }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Hold Ctrl (Cmd on Mac) to select multiple</p>
            </div>
        </div>

        <div class="pt-4">
            <button type="submit"
                class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Register User
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Set default datetime to now
    const now = new Date();
    const timezoneOffset = now.getTimezoneOffset() * 60000; // offset in milliseconds
    const localISOTime = (new Date(now - timezoneOffset)).toISOString().slice(0, 16);
    document.getElementById('date_joined').value = localISOTime;

    // Fetch groups and permissions
    fetch('/api/user_groups/')
        .then(res => res.json())
        .then(data => {
            const groupSelect = document.getElementById('groups');
            data.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
        });

    fetch('/api/permissions/')
        .then(res => res.json())
        .then(data => {
            const permSelect = document.getElementById('user_permissions');
            data.forEach(perm => {
                const option = document.createElement('option');
                option.value = perm.id;
                option.textContent = `${perm.name}`;
                permSelect.appendChild(option);
            });
        });

    // Form submission handling
    const form = document.getElementById('register-form');
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        // Clear previous error messages
        const errorContainers = document.querySelectorAll('.error-message');
        errorContainers.forEach(el => el.remove());

        // Collect form data
        const formData = new FormData(form);

        // Convert multiple select values to arrays
        const groups = Array.from(form.querySelector('#groups').selectedOptions).map(opt => opt.value);
        const permissions = Array.from(form.querySelector('#user_permissions').selectedOptions).map(opt => opt.value);

        // Build JSON payload
        const payload = {
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            confirm_password: formData.get('confirm_password'),
            date_joined: formData.get('date_joined'),
            is_staff: formData.get('is_staff') === 'on',
            is_superuser: formData.get('is_superuser') === 'on',
            groups: groups,
            user_permissions: permissions,
        };

        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                'Accept': 'application/json',
            },
            body: JSON.stringify(payload),
        })
        .then(response => {
if (response.ok) {
    return response.json().then(data => {
        // Create a styled notification
        const notification = document.createElement('div');
        notification.className = `
            fixed top-10 right-4 z-50
            bg-green-600 text-white font-medium
            px-6 py-4 rounded-lg shadow-xl
            flex items-center space-x-2 animate-slide-in
        `;
        notification.innerHTML = `
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            <span>User registered successfully!</span>
        `;
        document.body.appendChild(notification);

        // Remove after 3s
        setTimeout(() => {
            notification.remove();
        }, 3000);

        form.reset();
        document.getElementById('date_joined').value = localISOTime;
    });
} else if (response.status === 400) {
    return response.json().then(data => {
        Object.keys(data).forEach(field => {
            const fieldElement = form.querySelector(`[name=${field}]`);
            if (fieldElement) {
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('error-message', 'text-red-600', 'mt-1', 'text-sm');
                errorDiv.textContent = Array.isArray(data[field]) ? data[field].join(' ') : data[field];
                fieldElement.parentNode.appendChild(errorDiv);
            }
        });
                });
            } else {
                throw new Error('Unexpected error occurred');
            }
        })
        .catch(err => {
            console.error('Fetch error:', err);
            alert('Network error, please try again.');
        });
    });
});
</script>

{% endblock %} {% endcomment %}