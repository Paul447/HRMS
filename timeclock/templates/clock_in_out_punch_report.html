{% extends 'dashboard.html' %}

{% block title %}Employee Clock Data Report{% endblock %}

{% block content %}
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6">Employee Clock Data Report (Admin)</h1>

        <div class="mb-6 bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
            <div>
                <label for="payPeriodSelector" class="block text-gray-700 text-sm font-bold mb-2">Select Pay Period:</label>
                <select id="payPeriodSelector" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">Loading Pay Periods...</option>
                </select>
            </div>
            <button id="exportExcelButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded opacity-50 cursor-not-allowed" disabled>
                Export to Excel
            </button>
        </div>

        <div id="clockDataReportContainer" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
            <p class="text-gray-500">Select a pay period to view clock data.</p>
        </div>
    </div>

<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
    // static/timeclock/js/admin_clock_data.js // Inlined here for completeness

    // --- Utility function for authenticated fetches ---
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('access_token'); // Or wherever you store your token

        const headers = {
            'Content-Type': 'application/json',
            ...options.headers,
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(url, {
            ...options,
            headers: headers,
        });

        if (response.status === 401) {
            console.error("Authentication failed or token expired. Redirecting to login.");
            window.location.href = '/login/'; // Adjust to your login URL
        }

        return response;
    }

    // --- Function to render the aggregated clock data report as a TABLE (simplified for display) ---
    // The complex layout with nested rows and merges will be handled by the Excel export.
    function renderClockDataReport(containerElement, data) {
        containerElement.innerHTML = ''; // Clear previous content

        if (!data || !data.pay_period || !data.users_clock_data) {
            containerElement.innerHTML = '<p class="text-red-600">Failed to load report data.</p>';
            return;
        }

        const payPeriodStartDate = data.pay_period.start_date_local;
        const payPeriodEndDate = data.pay_period.end_date_local;

        let tableHtml = `
            <h2 class="text-xl font-bold mb-4 text-gray-800">Clock Data for Pay Period: <span class="text-primary-600">${payPeriodStartDate} to ${payPeriodEndDate}</span></h2>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="clockDataTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" rowspan="2">
                                Employee
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" rowspan="2">
                                Week Total
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" colspan="2">
                                Week Punches
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" rowspan="2">
                                Week Punches Duration
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" rowspan="2">
                                Regular
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" rowspan="2">
                                OT
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" rowspan="2">
                                Total Hours
                            </th>
                        </tr>
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                IN
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                OUT
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
        `;

        if (data.users_clock_data.length > 0) {
            data.users_clock_data.forEach(userData => {
                const employeeName = `${userData.first_name} ${userData.last_name} `;
                const totalHours = userData.week_1_total_hours + userData.week_2_total_hours || 'N/A'; // Assuming employee_type exists in your data

                const week1Punches = userData.week_1_entries;
                const week2Punches = userData.week_2_entries;

                const week1RowsCount = Math.max(1, week1Punches.length);
                const week2RowsCount = Math.max(1, week2Punches.length);

                const totalRowsForEmployee = week1RowsCount + week2RowsCount;


                // --- Week 1 Block ---
                for (let i = 0; i < week1RowsCount; i++) {
                    const punch = week1Punches[i];
                    tableHtml += `
                        <tr>
                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" rowspan="${totalRowsForEmployee}">
                                ${employeeName}

                            </td>` : ''}

                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${week1RowsCount}">
                                Week 1 = ${parseFloat(userData.week_1_total_hours).toFixed(2)}
                            </td>` : ''}

                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${punch ? new Date(punch.clock_in_time).toLocaleString() : 'No Punches'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${punch && punch.clock_out_time ? new Date(punch.clock_out_time).toLocaleString() : (punch ? 'Active' : '')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${punch ? `${parseFloat(punch.hours_worked || 0).toFixed(2)} hrs` : '0.00 hrs'}
                            </td>

                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${week1RowsCount}">
                                ${parseFloat(userData.regular_hours_week_1 || 0).toFixed(2)}
                            </td>` : ''}
                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${week1RowsCount}">
                                ${parseFloat(userData.overtime_hours_week_1 || 0).toFixed(2)}
                            </td>` : ''}

                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${totalRowsForEmployee}">
                                ${totalHours}
                            </td>` : ''}
                        </tr>
                    `;
                }

                // --- Week 2 Block ---
                for (let i = 0; i < week2RowsCount; i++) {
                    const punch = week2Punches[i];
                    tableHtml += `
                        <tr>
                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${week2RowsCount}">
                                Week 2 = ${parseFloat(userData.week_2_total_hours).toFixed(2)}
                            </td>` : ''}

                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${punch ? new Date(punch.clock_in_time).toLocaleString() : 'No Punches'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${punch && punch.clock_out_time ? new Date(punch.clock_out_time).toLocaleString() : (punch ? 'Active' : '')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${punch ? `${parseFloat(punch.hours_worked || 0).toFixed(2)} hrs` : '0.00 hrs'}
                            </td>

                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${week2RowsCount}">
                                ${parseFloat(userData.regular_hours_week_2 || 0).toFixed(2)}
                            </td>` : ''}
                            ${i === 0 ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" rowspan="${week2RowsCount}">
                                ${parseFloat(userData.overtime_hours_week_2 || 0).toFixed(2)}
                            </td>` : ''}
                        </tr>
                    `;
                }
            });
        } else {
            tableHtml += `
                <tr>
                    <td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-600">
                        No clock data found for any user in this pay period.
                    </td>
                </tr>
            `;
        }

        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;

        containerElement.innerHTML = tableHtml;

        const exportButton = document.getElementById('exportExcelButton');
        if (exportButton) {
            if (data && data.users_clock_data && data.users_clock_data.length > 0) {
                exportButton.disabled = false;
                exportButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                exportButton.disabled = true;
                exportButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
    }

    // --- Function to trigger XLSX download using SheetJS ---
    async function exportToXLSX(filename) {
    // Ensure ExcelJS is available
    if (typeof ExcelJS === 'undefined') {
        console.error('ExcelJS library not loaded. Include it via CDN or npm.');
        alert('ExcelJS library is required to export the file.');
        return;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Clock Data Report');

    // Set column widths
    worksheet.columns = [
        { width: 25 }, // A: Employee
        { width: 15 }, // B: Week Total
        { width: 20 }, // C: Week Punches - IN
        { width: 20 }, // D: Week Punches - OUT
        { width: 15 }, // E: Week Punches Duration
        { width: 10 }, // F: Regular
        { width: 10 }, // G: OT
        { width: 15 }  // H: Employee Type
    ];

    // Add headers
    worksheet.addRow(["Employee", "Week Total", "Week Punches", "", "Week Punches Duration", "Regular", "OT", "Total Hours"]);
    worksheet.addRow(["", "", "IN", "OUT", "", "", "", ""]);

    // Merge header cells
    worksheet.mergeCells('A1:A2');
    worksheet.mergeCells('B1:B2');
    worksheet.mergeCells('C1:D1');
    worksheet.mergeCells('E1:E2');
    worksheet.mergeCells('F1:F2');
    worksheet.mergeCells('G1:G2');
    worksheet.mergeCells('H1:H2');

    // Style headers
    worksheet.getRow(1).eachCell(cell => {
        cell.font = { bold: true };
        cell.alignment = { vertical: 'middle', horizontal: 'center' };
    });
    worksheet.getRow(2).eachCell(cell => {
        cell.font = { bold: true };
        cell.alignment = { vertical: 'middle', horizontal: 'center' };
    });

    let currentRow = 3;
    let otCellsToHighlight = []; // Track cells for conditional formatting

    const currentData = document.getElementById('clockDataReportContainer').currentReportData;
    if (!currentData || !currentData.users_clock_data) {
        console.error('No report data available:', currentData);
        alert('No report data available to export.');
        return;
    }

    currentData.users_clock_data.forEach(userData => {
        const employeeName = `${userData.first_name} ${userData.last_name}`;
        const employeeType = (userData.week_1_total_hours + userData.week_2_total_hours) || 'N/A';

        const week1Total = parseFloat(userData.week_1_total_hours || 0).toFixed(2);
        const week2Total = parseFloat(userData.week_2_total_hours || 0).toFixed(2);
        const week1Regular = parseFloat(userData.regular_hours_week_1 || 0);
        const week1OT = parseFloat(userData.overtime_hours_week_1 || 0);
        const week2Regular = parseFloat(userData.regular_hours_week_2 || 0);
        const week2OT = parseFloat(userData.overtime_hours_week_2 || 0);

        console.log(`Processing ${employeeName} - Week 1 OT: ${week1OT} (type: ${typeof week1OT}), Week 2 OT: ${week2OT} (type: ${typeof week2OT})`);

        const week1Punches = userData.week_1_entries || [];
        const week2Punches = userData.week_2_entries || [];

        const week1RowsCount = Math.max(1, week1Punches.length);
        const week2RowsCount = Math.max(1, week2Punches.length);

        const employeeBlockStartRow = currentRow;

        const shouldHighlightWeek1 = !isNaN(week1OT) && week1OT != 0;
        const shouldHighlightWeek2 = !isNaN(week2OT) && week2OT != 0;

        if (shouldHighlightWeek1) console.log(`Highlighting OT cell G${currentRow} for ${employeeName}, Week 1 OT: ${week1OT}`);
        if (shouldHighlightWeek2) console.log(`Highlighting OT cell G${currentRow + week1RowsCount} for ${employeeName}, Week 2 OT: ${week2OT}`);

        // Week 1 block
        for (let i = 0; i < week1RowsCount; i++) {
            const punch1 = week1Punches[i];
            const row = worksheet.addRow([
                i === 0 ? employeeName : "",
                i === 0 ? `Week 1 = ${week1Total}` : "",
                punch1 ? new Date(punch1.clock_in_time).toLocaleString() : (i === 0 && week1Punches.length === 0 ? "No Punches" : ""),
                punch1 && punch1.clock_out_time ? new Date(punch1.clock_out_time).toLocaleString() : (punch1 ? 'Active' : ''),
                punch1 ? parseFloat(punch1.hours_worked || 0) : (i === 0 && week1Punches.length === 0 ? 0 : ""), // Store as number
                i === 0 ? week1Regular : "",
                i === 0 ? week1OT : "", // Store as number
                i === 0 ? employeeType : ""
            ]);

            // Format Week Punches Duration (E) as number with two decimals
            if (punch1 || (i === 0 && week1Punches.length === 0)) {
                const durationCell = row.getCell('E');
                durationCell.numFmt = '0.00';
            }

            // Highlight only the OT cell (column G) if non-zero
            if (i === 0 && shouldHighlightWeek1) {
                const otCell = row.getCell('G');
                otCell.numFmt = '0.00'; // Ensure number format with two decimals
                otCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } }; // Red
                otCellsToHighlight.push(`G${currentRow}`);
            }
            currentRow++;
        }

        if (week1RowsCount > 1) {
            worksheet.mergeCells(`B${employeeBlockStartRow}:B${employeeBlockStartRow + week1RowsCount - 1}`);
            worksheet.mergeCells(`F${employeeBlockStartRow}:F${employeeBlockStartRow + week1RowsCount - 1}`);
            worksheet.mergeCells(`G${employeeBlockStartRow}:G${employeeBlockStartRow + week1RowsCount - 1}`);
        }

        const week2BlockStartRow = currentRow;

        // Week 2 block
        for (let i = 0; i < week2RowsCount; i++) {
            const punch2 = week2Punches[i];
            const row = worksheet.addRow([
                "",
                i === 0 ? `Week 2 = ${week2Total}` : "",
                punch2 ? new Date(punch2.clock_in_time).toLocaleString() : (i === 0 && week2Punches.length === 0 ? "No Punches" : ""),
                punch2 && punch2.clock_out_time ? new Date(punch2.clock_out_time).toLocaleString() : (punch2 ? 'Active' : ''),
                punch2 ? parseFloat(punch2.hours_worked || 0) : (i === 0 && week2Punches.length === 0 ? 0 : ""), // Store as number
                i === 0 ? week2Regular : "",
                i === 0 ? week2OT : "", // Store as number
                ""
            ]);

            // Format Week Punches Duration (E) as number with two decimals
            if (punch2 || (i === 0 && week2Punches.length === 0)) {
                const durationCell = row.getCell('E');
                durationCell.numFmt = '0.00';
            }

            // Highlight only the OT cell (column G) if non-zero
            if (i === 0 && shouldHighlightWeek2) {
                const otCell = row.getCell('G');
                otCell.numFmt = '0.00'; // Ensure number format with two decimals
                otCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFF0000' } }; // Red
                otCellsToHighlight.push(`G${currentRow}`);
            }
            currentRow++;
        }

        if (week2RowsCount > 1) {
            worksheet.mergeCells(`B${week2BlockStartRow}:B${week2BlockStartRow + week2RowsCount - 1}`);
            worksheet.mergeCells(`F${week2BlockStartRow}:F${week2BlockStartRow + week2RowsCount - 1}`);
            worksheet.mergeCells(`G${week2BlockStartRow}:G${week2BlockStartRow + week2RowsCount - 1}`);
        }

        // Merge Employee and Employee Type
        if (currentRow - employeeBlockStartRow > 1) {
            worksheet.mergeCells(`A${employeeBlockStartRow}:A${currentRow - 1}`);
            worksheet.mergeCells(`H${employeeBlockStartRow}:H${currentRow - 1}`);
        }

        // Add blank row
        worksheet.addRow(["", "", "", "", "", "", "", ""]);
        currentRow++;
    });

    // Add conditional formatting for specific OT cells (fallback)
    otCellsToHighlight.forEach(cellRef => {
        worksheet.addConditionalFormatting({
            ref: cellRef,
            rules: [{
                type: 'cellIs',
                operator: 'greaterThan',
                formulae: ['0'],
                style: { fill: { type: 'pattern', pattern: 'solid', bgColor: { argb: 'FFFF0000' } } }
            }]
        });
    });

    console.log('Conditional Formatting Applied to:', otCellsToHighlight);

    // Save file
    try {
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
        console.log('File generated successfully:', filename);
    } catch (error) {
        console.error('Error generating XLSX file:', error);
        alert('Failed to generate XLSX file. Check console for details.');
    }
}

    // --- Function to fetch and populate the pay period selector dropdown ---
    async function populatePayPeriodSelector() {
        const payPeriodSelect = document.getElementById('payPeriodSelector');
        if (!payPeriodSelect) {
            console.error("HTML element with ID 'payPeriodSelector' not found.");
            return;
        }

        payPeriodSelect.innerHTML = '<option value="">Loading Pay Periods...</option>'; // Set loading state

        try {
            const response = await fetchWithAuth('/api/clock/pay_periods/');
            if (!response.ok) {
                throw new Error(`Failed to fetch pay periods: ${response.statusText}`);
            }
            const payPeriods = await response.json();

            payPeriodSelect.innerHTML = '<option value="">Select a Pay Period</option>';

            if (payPeriods.length > 0) {
                payPeriods.forEach(payPeriod => {
                    const option = document.createElement('option');
                    option.value = payPeriod.id;
                    option.textContent = `${payPeriod.start_date_local} to ${payPeriod.end_date_local}`;
                    payPeriodSelect.appendChild(option);
                });
                // Optionally, pre-select the most recent pay period
                if (payPeriods[0] && payPeriods[0].id) {
                    payPeriodSelect.value = payPeriods[0].id;
                    fetchClockDataForPayPeriod(payPeriods[0].id);
                }

            } else {
                payPeriodSelect.innerHTML = '<option value="">No Pay Periods Found</option>';
                payPeriodSelect.disabled = true; // Disable if no periods are found
            }

            payPeriodSelect.addEventListener('change', (event) => {
                const selectedPayPeriodId = event.target.value;
                const reportContainer = document.getElementById('clockDataReportContainer');
                const exportButton = document.getElementById('exportExcelButton');

                if (selectedPayPeriodId) {
                    fetchClockDataForPayPeriod(selectedPayPeriodId);
                } else {
                    if (reportContainer) {
                        reportContainer.innerHTML = '<p class="text-gray-500">Select a pay period to view clock data.</p>';
                    }
                    if (exportButton) {
                        exportButton.disabled = true;
                        exportButton.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            });

        } catch (error) {
            console.error("Error populating pay period selector:", error);
            payPeriodSelect.innerHTML = '<option value="">Error loading periods</option>';
            payPeriodSelect.disabled = true; // Disable on error
        }
    }

    // --- Function to fetch clock data for a specific pay period and render it ---
    async function fetchClockDataForPayPeriod(payPeriodId) {
        const reportContainer = document.getElementById('clockDataReportContainer');
        const exportButton = document.getElementById('exportExcelButton');
        if (!reportContainer || !exportButton) {
            console.error("Required HTML elements not found.");
            return;
        }
        reportContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Loading clock data for the selected pay period...</p>'; // Loading indicator
        exportButton.disabled = true; // Disable while loading
        exportButton.classList.add('opacity-50', 'cursor-not-allowed');

        try {
            const response = await fetchWithAuth(`/api/clock/?pay_period_id=${payPeriodId}`);
            if (!response.ok) {
                throw new Error(`Failed to fetch clock data: ${response.statusText}`);
            }
            const data = await response.json();
            

            // Store the fetched data directly on the container element for easier access by XLSX export
            reportContainer.currentReportData = data;

            renderClockDataReport(reportContainer, data); // Render the fetched data

        } catch (error) {
            console.error("Error fetching clock data for pay period:", error);
            reportContainer.innerHTML = `<p class="text-red-600 text-center py-4">Error loading clock data: ${error.message}</p>`;
            exportButton.disabled = true; // Ensure disabled on error
            exportButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    // --- Initialize the process when the DOM is fully loaded ---
    document.addEventListener('DOMContentLoaded', () => {
        populatePayPeriodSelector();

        const exportButton = document.getElementById('exportExcelButton');
        if (exportButton) {
            exportButton.addEventListener('click', () => {
                const payPeriodSelect = document.getElementById('payPeriodSelector');
                const selectedOption = payPeriodSelect.options[payPeriodSelect.selectedIndex];
                const payPeriodText = selectedOption.textContent.trim();
                const filename = `Employee_Clock_Report_${payPeriodText.replace(/[^a-zA-Z0-9_ -]/g, '')}.xlsx`; // Change to .xlsx
                exportToXLSX(filename); // Call the new XLSX export function
            });
        }
    });

</script>
{% endblock %}