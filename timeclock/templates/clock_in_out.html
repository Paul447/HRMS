{% extends 'dashboard.html' %}

{% block title %}Clock In/Out{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-md overflow-hidden">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Time Tracking</h1>
            <div class="w-20 h-1 bg-blue-500 mx-auto"></div>
        </div>
        
        <div id="payPeriodCard" class="bg-blue-50 rounded-lg p-4 mb-8 border border-blue-100">
            <div class="text-center text-gray-500">Loading pay period data...</div>
        </div>
        
        <div id="clockInOutCard" class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-6 mb-8 shadow-inner border border-gray-200">
            <div class="text-center text-gray-500">Loading clock status...</div>
        </div>

        <div id="timeEntriesSection" class="space-y-8">
            <div class="text-center text-gray-500">Loading time entries...</div>
        </div>
    </div>

{% load static %}
<script>
   // Helper function to get CSRF token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    console.log("CSRF Token:", csrftoken);

    // Formats an ISO string to a displayable date (e.g., "Fri 05/30")
    function formatDate(isoString) {
        if (!isoString) {
            console.warn("formatDate called with null or undefined isoString:", isoString);
            return 'N/A';
        }
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) {
                console.error("Invalid date string passed to formatDate:", isoString);
                return 'Invalid Date';
            }
            const options = { weekday: 'short', month: '2-digit', day: '2-digit', year: '2-digit' };
            return date.toLocaleString(navigator.language, options);
        } catch (e) {
            console.error("Error formatting date:", isoString, e);
            return 'Error Formatting';
        }
    }

    // Formats an ISO string to a displayable time (e.g., "11:24 AM")
    function formatOnlyTime(isoString) {
        if (!isoString) {
            // For a null clock_out_time on an active entry, this will return an empty string, which is desired
            return ''; 
        }
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) {
                console.error("Invalid date string passed to formatOnlyTime:", isoString);
                return 'Invalid Time';
            }
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleString(navigator.language, options);
        } catch (e) {
            console.error("Error formatting time:", isoString, e);
            return 'Error Time';
        }
    }
    
    // Calculates duration between two ISO strings and formats it (e.g., "X:YY")
    function formatDuration(clockInIso, clockOutIso) {
        if (!clockInIso || !clockOutIso) {
            console.warn("formatDuration called with missing clockInIso or clockOutIso for calculation:", clockInIso, clockOutIso);
            return '0:00'; // Default for incomplete data
        }
        try {
            const inTime = new Date(clockInIso);
            const outTime = new Date(clockOutIso);

            if (isNaN(inTime.getTime()) || isNaN(outTime.getTime())) {
                console.error("Invalid date(s) in formatDuration:", clockInIso, clockOutIso);
                return 'Invalid Duration';
            }

            const diffMs = outTime - inTime;

            if (diffMs < 0) {
                console.warn("Clock out time is before clock in time for duration calculation.");
                return 'Invalid Duration';
            }

            const totalSeconds = Math.floor(diffMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);

            return `${hours}:${minutes.toString().padStart(2, '0')}`;
        } catch (e) {
            console.error("Error calculating duration:", clockInIso, clockOutIso, e);
            return 'Error Calc.';
        }
    }

    // Renders the Pay Period Card
    function renderPayPeriodCard(data) {
        const payPeriodCard = document.getElementById('payPeriodCard');
        if (!payPeriodCard) {
            console.error("Element with ID 'payPeriodCard' not found!");
            return;
        }

        console.log("Rendering Pay Period Card with data:", data);

        // Handle case where no active pay period is found
        if (!data || !data.pay_period) {
            payPeriodCard.innerHTML = `
                <div class="flex items-center text-red-600">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span>No active pay period found</span>
                </div>
            `;
            return;
        }

        const pp = data.pay_period;
        const weekBoundaries = data.week_boundaries;

        // Ensure week_boundaries exist and are valid before formatting
        const week1Start = weekBoundaries ? weekBoundaries.week_1_start : 'N/A';
        const week1End = weekBoundaries ? weekBoundaries.week_1_end : 'N/A';
        const week2Start = weekBoundaries ? formatDate(weekBoundaries.week_2_start) : 'N/A';
        const week2End = weekBoundaries ? formatDate(weekBoundaries.week_2_end) : 'N/A';

        payPeriodCard.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h2 class="text-xl font-semibold text-blue-800">Current Pay Period</h2>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 8 8">
                        <circle cx="4" cy="4" r="3" />
                    </svg>
                    Active
                </span>
            </div>
            <div class="space-y-3">
                <div class="flex flex-wrap items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-gray-700 font-medium">${pp.start_date_local.split(' ')[0]} - ${pp.end_date_local.split(' ')[0]}</span>
                </div>
                <div class="flex items-center gap-2 bg-blue-100/50 border border-blue-200 rounded-full px-3 py-1.5 w-fit">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm font-medium text-blue-800">Week ${data.week_number || 'N/A'}: ${week1Start} - ${week1End} | ${week2Start} - ${week2End}</span>
                </div>
            </div>
        `;
    }

    // Renders the Clock In/Out Card
    function renderClockInOutCard(data) {
        const clockInOutCard = document.getElementById('clockInOutCard');
        if (!clockInOutCard) {
            console.error("Element with ID 'clockInOutCard' not found!");
            return;
        }

        console.log("Rendering Clock In/Out Card with data:", data);

        let buttonHtml = '';
        let statusHtml = '';

        if (data.current_status === "Clocked In" && data.active_clock_entry) {
            const clockInTime = formatOnlyTime(data.active_clock_entry.clock_in_time);
            let initialDuration = '0:00';
            if (data.active_clock_entry.clock_in_time) {
                initialDuration = formatDuration(data.active_clock_entry.clock_in_time, new Date().toISOString());
            }
            
            statusHtml = `
                <div class="inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800 mb-3">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-medium">Clocked In</span>
                </div>
                <p class="text-gray-600 mb-1">Since: <span class="font-medium text-gray-800">${formatDate(data.active_clock_entry.clock_in_time)} ${clockInTime}</span></p>
                <p class="text-sm text-gray-500">Duration: <span id="currentDuration">${initialDuration}</span></p>
            `;
            buttonHtml = `
                <button id="clockButton" class="w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Clock Out
                </button>
            `;

            // Update duration every second if clocked in
            if (window.durationInterval) clearInterval(window.durationInterval);
            window.durationInterval = setInterval(() => {
                if (data.active_clock_entry && data.active_clock_entry.clock_in_time) {
                    const updatedDuration = formatDuration(data.active_clock_entry.clock_in_time, new Date().toISOString());
                    const durationElement = document.getElementById('currentDuration');
                    if (durationElement) {
                        durationElement.textContent = updatedDuration;
                    } else {
                        clearInterval(window.durationInterval);
                        window.durationInterval = null;
                        console.warn("currentDuration element not found, clearing duration interval.");
                    }
                }
            }, 1000);

        } else {
            // Clocked Out State
            if (window.durationInterval) clearInterval(window.durationInterval);
            statusHtml = `
                <div class="inline-flex items-center px-4 py-2 rounded-full bg-gray-100 text-gray-800 mb-3">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-medium">Clocked Out</span>
                </div>
                <p class="text-gray-600">Ready to start your workday?</p>
            `;
            buttonHtml = `
                <button id="clockButton" class="w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Clock In
                </button>
            `;
        }

        clockInOutCard.innerHTML = `
            <div class="text-center">
                <div class="mb-5">
                    ${statusHtml}
                </div>
                ${buttonHtml}
            </div>
        `;
        
        const clockButton = document.getElementById('clockButton');
        if (clockButton) {
            clockButton.addEventListener('click', handleClockAction);
        } else {
            console.error("Clock button element not found after rendering clockInOutCard.");
        }
    }

    // Renders time entries for a given week
    function renderWeekEntries(weekNum, entries, totalHours) {
        const timeEntriesSection = document.getElementById('timeEntriesSection');
        if (!timeEntriesSection) {
            console.error("Element with ID 'timeEntriesSection' not found!");
            return;
        }

        console.log(`Rendering Week ${weekNum} entries:`, entries, `Total: ${totalHours}`);

        if (!entries || entries.length === 0) {
            return; // Don't render if no entries for this week
        }

        const entriesHtml = entries.map(entry => {
            const displayClockOutTime = entry.clock_out_time ? formatOnlyTime(entry.clock_out_time) : 'Still In';
            const displayHoursWorked = entry.hours_worked !== null ? parseFloat(entry.hours_worked).toFixed(2) : '0.00'; // Ensure two decimal places

            return `
                <div class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div class="flex items-center mb-2 sm:mb-0">
                            <span class="text-sm font-medium text-gray-500 mr-3">${formatDate(entry.clock_in_time)}</span>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${displayHoursWorked} hours</span>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span class="font-medium">${formatOnlyTime(entry.clock_in_time)}</span> - 
                            <span class="font-medium">${displayClockOutTime}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        const weekSectionHtml = `
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-2">${weekNum}</span>
                        Week ${weekNum} Summary
                    </h3>
                </div>
                <div class="divide-y divide-gray-200">
                    ${entriesHtml}
                </div>
                <div class="px-6 py-3 bg-gray-50 text-right">
                    <p class="text-sm font-medium text-gray-700">
                        Total: <span class="text-blue-600 font-bold">${parseFloat(totalHours).toFixed(2) || '0.00'} hours</span>
                    </p>
                </div>
            </div>
        `;
        timeEntriesSection.insertAdjacentHTML('beforeend', weekSectionHtml);
    }

    // Main function to fetch and render all data
    async function fetchAndRenderClockData() {
        try {
            const response = await fetch('/clock/user-clock-data/', {
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error(`HTTP error! Status: ${response.status}`, errorData);
                alert("Failed to load clock data: " + (errorData.detail || errorData.message || "Unknown API error."));
                return;
            }

            const data = await response.json();
            console.log("API Response Data:", data);

            renderPayPeriodCard(data);
            renderClockInOutCard(data);
            
            // Clear existing entries before rendering new ones to prevent duplicates on re-render
            const timeEntriesSection = document.getElementById('timeEntriesSection');
            if (timeEntriesSection) {
                timeEntriesSection.innerHTML = '';
            } else {
                console.error("Element with ID 'timeEntriesSection' not found for clearing!");
            }

            renderWeekEntries(1, data.week_1_entries, data.week_1_total_hours);
            renderWeekEntries(2, data.week_2_entries, data.week_2_total_hours);

        } catch (error) {
            console.error("Network or parsing error during fetchAndRenderClockData:", error);
            alert("An error occurred while fetching data. Please try again. Check console for details.");
        }
    }

    // Function to handle clock in/out action
    async function handleClockAction() {
        console.log("Clock button clicked. Attempting clock action...");
        try {
            const response = await fetch('/clock/clock-in-out/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            const data = await response.json();
            console.log("Clock action API Response:", data);

            if (response.ok) {
                alert(data.message);
                // Re-fetch and re-render all data to update the UI
                fetchAndRenderClockData();
            } else {
                console.error("Error performing clock action:", data);
                alert("Failed to perform clock action: " + (data.detail || data.message || "Unknown error."));
            }
        } catch (error) {
            console.error("Network or parsing error on clock action:", error);
            alert("An error occurred. Please try again. Check console for details.");
        }
    }

    // Initial data load when the page loads
    document.addEventListener('DOMContentLoaded', fetchAndRenderClockData);
    console.log("Script loaded and DOMContentLoaded listener attached.");
</script>
{% endblock %}

